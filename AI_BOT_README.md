# 🤖 AI-Powered Tattoo Studio Bot

## Полностью AI-ориентированная система бронирования

Этот бот **полностью построен на AI** и использует GPT-4 для естественного диалога с клиентами на любом языке. Больше никаких кнопок и команд - только естественное общение!

---

## 🌟 Основные возможности

### 💬 Естественный диалог
- **Понимает русский, английский и иврит**
- Автоматически определяет язык пользователя
- Отвечает на том же языке
- Поддерживает контекст разговора
- Естественное общение без жёстких команд

### 🎨 Консультации по татуировкам
- Помощь в выборе дизайна
- Советы по размеру и расположению
- Рекомендации по стилям
- Ответы на вопросы об уходе
- Обработка референсных изображений

### 📅 Умное бронирование
- **Через естественный язык**: "Хочу записаться на следующей неделе"
- Показ доступных слотов
- Создание, изменение и отмена записей
- Автоматическая синхронизация с Google Calendar
- Напоминания клиентам

### 👑 Административные функции
- Управление расписанием через диалог
- Просмотр всех бронирований
- Статистика и аналитика
- Управление клиентами
- Все через естественный язык!

---

## 🏗️ Архитектура

### AI Компоненты

```
┌─────────────────────────────────────────────────────────┐
│                    Telegram User                         │
│              (пишет на любом языке)                      │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│                   AI Handler                             │
│        (src/bot/handlers/ai_handler.py)                  │
│   • Принимает все сообщения                              │
│   • Определяет роль пользователя                         │
│   • Передаёт в AI Orchestrator                           │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│                AI Orchestrator                           │
│        (src/services/ai_orchestrator.py)                 │
│   • Собирает контекст (записи, слоты)                    │
│   • Управляет AI Dialog Engine                           │
│   • Выполняет действия через сервисы                     │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────┐
│              AI Dialog Engine                            │
│        (src/services/ai_dialog_engine.py)                │
│   • GPT-4 для понимания намерений                        │
│   • Function Calling для действий                        │
│   • История диалогов                                     │
│   • Мультиязычность                                      │
└──────────────────────┬──────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
        ▼                             ▼
┌───────────────┐            ┌────────────────┐
│  GPT-4 API    │            │   Действия     │
│  (OpenAI)     │            │   • Booking    │
│               │            │   • Calendar   │
│  • Диалог     │            │   • Admin      │
│  • Перевод    │            │   • Client     │
│  • Намерения  │            │                │
└───────────────┘            └────────────────┘
```

### Ключевые файлы

1. **`src/services/ai_dialog_engine.py`** - Центральный AI движок
   - Обработка через GPT-4
   - Function Calling для действий
   - История диалогов
   - Мультиязычность

2. **`src/services/ai_orchestrator.py`** - Оркестратор
   - Связь AI с реальными сервисами
   - Выполнение действий
   - Форматирование ответов

3. **`src/bot/handlers/ai_handler.py`** - Telegram handler
   - Приём сообщений
   - Определение ролей
   - Отправка ответов

---

## 🚀 Установка и запуск

### 1. Установка зависимостей

```bash
cd tattoo_appointment_bot
pip install -r requirements.txt
```

### 2. Настройка .env

Убедитесь что в `.env` есть OpenAI ключ:

```bash
# AI Configuration
OPENAI_API_KEY=sk-your-openai-api-key-here
```

### 3. Запуск бота

```bash
python run.py
```

---

## 💡 Примеры использования

### Для клиентов

**Русский:**
```
👤 Привет! Хочу сделать маленькую тату на запястье
🤖 Привет! Отличная идея 😊 Что-то конкретное в голове или хочешь обсудить варианты?

👤 Может что-то минималистичное
🤖 Минимализм - отличный выбор для запястья! Символы, геометрия или что-то личное?

👤 Когда можно записаться?
🤖 Проверяю свободное время... [показывает слоты]

👤 Запиши меня на 15 декабря в 14:00
🤖 ✅ Отлично! Ваша запись создана на 15 декабря в 14:00. Жду вас!
```

**English:**
```
👤 Hi, I want a small tattoo
🤖 Hi! What did you have in mind?

👤 Something on my wrist, minimalistic
🤖 Great choice! Let me show you available times...

👤 Book me for December 15 at 2pm
🤖 ✅ Done! Your appointment is on December 15 at 2pm. See you!
```

**עברית:**
```
👤 שלום, אני רוצה קעקוע קטן
🤖 שלום! מה חשבת לעשות?

👤 משהו על היד, מינימליסטי
🤖 בחירה מעולה! הנה זמנים פנויים...

👤 תקבע לי ל-15 בדצמבר בשעה 14:00
🤖 ✅ מעולה! הפגישה נקבעה ל-15 בדצמבר בשעה 14:00!
```

### Для администраторов

```
👤 Покажи все записи на завтра
🤖 📋 Записи на завтра (4 декабря):
    1. Иван - 10:00 (тату на руке)
    2. Мария - 14:00 (тату на спине)
    3. Свободно - 17:00

👤 Добавь свободное время 20 декабря с 15:00 до 19:00
🤖 ✅ Добавлен слот 20 декабря 15:00-19:00

👤 Какая статистика за неделю?
🤖 📊 Статистика за неделю:
    • 12 записей
    • 8 завершено
    • 4 предстоящих
    • Средняя длительность: 2.5 часа
```

---

## 🔧 Доступные AI функции

### Клиентские
- `show_available_slots` - Показать свободные слоты
- `create_booking` - Создать запись
- `show_my_bookings` - Мои записи
- `cancel_booking` - Отменить запись
- `reschedule_booking` - Перенести запись

### Административные
- `view_all_bookings` - Все записи
- `view_schedule` - Расписание
- `add_available_slot` - Добавить слот
- `remove_slot` - Удалить слот
- `view_statistics` - Статистика
- `send_message_to_client` - Отправить сообщение клиенту

---

## ⚙️ Конфигурация

### Настройка AI движка

В `src/services/ai_dialog_engine.py`:

```python
# Модель OpenAI
self.model = "gpt-4o-mini"  # Быстрая и экономичная

# Максимальная длина истории
self.max_history_length = 20

# Температура (креативность)
temperature=0.7
```

### Роли пользователей

```python
class UserRole(Enum):
    CLIENT = "client"     # Обычные клиенты
    ADMIN = "admin"       # Администраторы
    MASTER = "master"     # Мастера
```

Администраторы определяются в `.env`:
```bash
ADMIN_USER_IDS=123456789, 987654321
```

---

## 📊 Мониторинг

Логи сохраняются в `logs/`:
- `bot.log` - общие логи бота
- AI запросы логируются с деталями:
  - user_id
  - action
  - language
  - success/error

---

## 🔒 Безопасность

- ✅ Разграничение прав по ролям
- ✅ Валидация всех действий
- ✅ История диалогов хранится в памяти (не в БД)
- ✅ Чувствительные данные не передаются в AI
- ✅ API ключи в .env (не в коде)

---

## 🎯 Преимущества AI подхода

### ❌ Старый подход (кнопки)
- Жёсткий флоу
- Ограниченные языки
- Множество кнопок
- Сложная навигация
- Не понимает контекст

### ✅ Новый подход (AI)
- Естественный диалог
- Любой язык
- Нет кнопок
- Интуитивно понятно
- Понимает контекст и намерения

---

## 🔄 Миграция со старой версии

Старые handlers **закомментированы**, но не удалены:

```python
# Legacy handlers (commented out)
# multilingual_handler.setup(dp)
# client_handlers.setup(dp)
# admin_handlers.setup(dp)
```

Если нужно вернуться - просто раскомментируйте и закомментируйте AI handler.

---

## 📝 Команды бота

- `/start` - Начать диалог
- `/help` - Помощь и примеры
- `/reset` - Очистить историю диалога
- `/admin` - Админ панель (только для админов)

**Но главное - просто пишите естественным языком! 😊**

---

## 🐛 Отладка

### Проблема: AI не отвечает
```bash
# Проверьте API ключ
echo $OPENAI_API_KEY

# Проверьте логи
tail -f logs/bot.log
```

### Проблема: AI не понимает язык
- AI автоматически определяет язык
- Можно использовать `/reset` для очистки истории
- Попробуйте более явные фразы

### Проблема: Действие не выполняется
- Проверьте что сервисы инициализированы
- Проверьте подключение к Google Sheets
- Посмотрите логи с деталями ошибки

---

## 🚀 Дальнейшее развитие

- [ ] Vision API для анализа референсных изображений
- [ ] Голосовые сообщения (Speech-to-Text)
- [ ] Генерация изображений (DALL-E) для эскизов
- [ ] Персональные рекомендации на основе истории
- [ ] Интеграция с CRM
- [ ] A/B тестирование промптов

---

## 📞 Поддержка

Если возникли вопросы:
1. Проверьте `/help` в боте
2. Посмотрите логи
3. Проверьте конфигурацию .env
4. Убедитесь что OpenAI API работает

---

## 📄 Лицензия

MIT License - используйте свободно!

---

**Сделано с ❤️ и AI для тату-студий будущего**
