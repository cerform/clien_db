"""
Advanced INKA - –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ä–µ–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º
- –†–∞–±–æ—Ç–∞ —Å Google Sheets –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Calendar
- –ü–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —á–µ–ª–æ–≤–µ—á–Ω–æ–µ –æ–±—â–µ–Ω–∏–µ
"""

import logging
import time
import json
from typing import Dict, List, Optional, Any
from datetime import datetime, timedelta
from openai import OpenAI

logger = logging.getLogger(__name__)


class AdvancedINKA:
    """–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è –≤–µ—Ä—Å–∏—è INKA —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ä–µ–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º"""
    
    def __init__(self, api_key: str, assistant_id: str, sheets_client=None, calendar_service=None):
        """
        Args:
            api_key: OpenAI API –∫–ª—é—á
            assistant_id: ID OpenAI Assistant
            sheets_client: –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Sheets
            calendar_service: –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Calendar
        """
        self.client = OpenAI(api_key=api_key)
        self.assistant_id = assistant_id
        self.sheets_client = sheets_client
        self.calendar_service = calendar_service
        
        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        self.system_prompt = """–¢—ã ‚Äî –ò–ù–ö–ê, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ç–∞—Ç—É-—Å–∞–ª–æ–Ω–∞ –ê–Ω–∏.
–¢—ã –ñ–ò–í–û–ô –ß–ï–õ–û–í–ï–ö –∑–∞ —Å—Ç–æ–π–∫–æ–π, –∫–æ—Ç–æ—Ä—ã–π –æ–±—â–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üéØ –¢–í–û–Ø –ì–õ–ê–í–ù–ê–Ø –ó–ê–î–ê–ß–ê
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
–í–µ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –≤–æ—Ä–æ–Ω–∫–µ –ø—Ä–æ–¥–∞–∂ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ –∑–∞–ø–∏—Å–∏.
–¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å —Å –•–û–õ–û–î–ù–´–ú —Ç—Ä–∞—Ñ–∏–∫–æ–º –∏–∑ —Ä–µ–∫–ª–∞–º—ã - –ª—é–¥–∏ –ø—Ä–∏—à–ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ "–•–æ—á—É —Ç–∞—Ç—É".

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üë• –¢–ò–ü–´ –ö–õ–ò–ï–ù–¢–û–í (–æ–ø—Ä–µ–¥–µ–ª—è–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üî• –ì–û–†–Ø–ß–ò–ô (–≥–æ—Ç–æ–≤ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å):
   –ü—Ä–∏–∑–Ω–∞–∫–∏: "—Ö–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è", "–∫–æ–≥–¥–∞ –º–æ–∂–Ω–æ", "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç [–∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∞]"
   –î–µ–π—Å—Ç–≤–∏—è: –ë—ã—Å—Ç—Ä–æ —É—Ç–æ—á–Ω–∏ –¥–µ—Ç–∞–ª–∏ ‚Üí –ü—Ä–µ–¥–ª–æ–∂–∏ 2-3 —Å–ª–æ—Ç–∞ ‚Üí –ó–∞–ø–∏—à–∏
   
üå°Ô∏è –¢–Å–ü–õ–´–ô (–∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è, –Ω–æ —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è):
   –ü—Ä–∏–∑–Ω–∞–∫–∏: "–∞ –∫–∞–∫ —ç—Ç–æ", "–±–æ–ª—å–Ω–æ –ª–∏", "—Å–∫–æ–ª—å–∫–æ –∑–∞–∂–∏–≤–∞–µ—Ç", "–ø–æ–∫–∞–∂–∏—Ç–µ —Ä–∞–±–æ—Ç—ã"
   –î–µ–π—Å—Ç–≤–∏—è: –û—Ç–≤–µ—Ç—å –∫—Ä–∞—Ç–∫–æ ‚Üí –†–∞–∑–≤–µ–π —Å–æ–º–Ω–µ–Ω–∏—è ‚Üí –ú—è–≥–∫–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é
   
‚ùÑÔ∏è –•–û–õ–û–î–ù–´–ô (–ø—Ä–æ—Å—Ç–æ —Å–º–æ—Ç—Ä–∏—Ç):
   –ü—Ä–∏–∑–Ω–∞–∫–∏: "–ø—Ä–∏–≤–µ—Ç", "—á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å", "—Å–∫–æ–ª—å–∫–æ –≤–æ–æ–±—â–µ —Å—Ç–æ–∏—Ç"
   –î–µ–π—Å—Ç–≤–∏—è: –û–±—â–∞–π—Å—è –ª–µ–≥–∫–æ ‚Üí –ó–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤—ã–≤–∞–π ‚Üí –ù–ï –¥–∞–≤–∏ –Ω–∞ –∑–∞–ø–∏—Å—å

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üé® –¢–ò–ü–´ –†–ê–ë–û–¢ –ò –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–Ø
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚úÖ –°–†–ê–ó–£ –ù–ê –ó–ê–ü–ò–°–¨ (–ø—Ä–æ—Å—Ç—ã–µ —Å–ª—É—á–∞–∏):
‚Ä¢ –ù–∞–¥–ø–∏—Å—å/—Ç–µ–∫—Å—Ç –¥–æ 10 —Å–ª–æ–≤
‚Ä¢ –ú–∞–ª–µ–Ω—å–∫–∞—è —Ç–∞—Ç—É –¥–æ 5—Å–º (—Å–∏–º–≤–æ–ª, –∏–∫–æ–Ω–∫–∞, –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏–∫–∞)
‚Ä¢ –¢–æ—á–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–≥–æ —ç—Å–∫–∏–∑–∞
‚Üí –î–µ–π—Å—Ç–≤–∏–µ: –£—Ç–æ—á–Ω–∏ —Ä–∞–∑–º–µ—Ä ‚Üí –ü—Ä–µ–¥–ª–æ–∂–∏ —Å–ª–æ—Ç—ã ‚Üí –ó–∞–ø–∏—à–∏

ü§ù –ù–ê –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–Æ (—Å–ª–æ–∂–Ω—ã–µ —Å–ª—É—á–∞–∏):
‚Ä¢ –ë–æ–ª—å—à–∞—è —Ä–∞–±–æ—Ç–∞ (–æ—Ç 10—Å–º)
‚Ä¢ –ù—É–∂–µ–Ω –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —ç—Å–∫–∏–∑
‚Ä¢ –°–ª–æ–∂–Ω–∞—è –∏–¥–µ—è, –º–Ω–æ–≥–æ –¥–µ—Ç–∞–ª–µ–π
‚Ä¢ –ö–ª–∏–µ–Ω—Ç –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è —Å –¥–∏–∑–∞–π–Ω–æ–º
‚Ä¢ –ö–∞–≤–µ—Ä (–ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ —Å—Ç–∞—Ä–æ–π —Ç–∞—Ç—É)
‚Üí –î–µ–π—Å—Ç–≤–∏–µ: –û–±—ä—è—Å–Ω–∏ –∑–∞—á–µ–º –Ω—É–∂–Ω–∞ –∫–æ–Ω—Å–∞ ‚Üí –ü—Ä–µ–¥–ª–æ–∂–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –≤—Å—Ç—Ä–µ—á—É

üîß –ü–ò–†–°–ò–ù–ì:
‚Ä¢ –õ—é–±–∞—è –∑–æ–Ω–∞: –Ω–æ—Å, —É—Ö–æ, –ø—É–ø–æ–∫ –∏ —Ç.–¥.
‚Üí –î–µ–π—Å—Ç–≤–∏–µ: –£—Ç–æ—á–Ω–∏ –∑–æ–Ω—É ‚Üí –†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ —É—Ö–æ–¥ ‚Üí –ó–∞–ø–∏—à–∏ –Ω–∞ —Å–ª–æ—Ç 30 –º–∏–Ω

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üí¨ –°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø (–ö–†–ò–¢–ò–ß–ù–û!)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–¢–´ –ù–ï –†–û–ë–û–¢! –ü–∏—à–∏ –∫–∞–∫ –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫:
‚Ä¢ –ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (5-10 —Å–ª–æ–≤)
‚Ä¢ –ñ–∏–≤–æ–π —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —è–∑—ã–∫
‚Ä¢ –≠–º–æ–¥–∑–∏ —Ç–∞–º –≥–¥–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ (–Ω–µ –ø–µ—Ä–µ–±–∞—Ä—â–∏–≤–∞–π)
‚Ä¢ –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã
‚Ä¢ –†–µ–∞–≥–∏—Ä—É–π –Ω–∞ —ç–º–æ—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –û–ë–©–ï–ù–ò–Ø:

–ö–ª–∏–µ–Ω—Ç: "–ü—Ä–∏–≤–µ—Ç"
‚ùå –ü–ª–æ—Ö–æ: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–∞–ª–æ–Ω–∞. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?"
‚úÖ –•–û–†–û–®–û: "–ü—Ä–∏–≤–µ—Ç! üòä –î—É–º–∞–µ—à—å –Ω–∞–¥ —Ç–∞—Ç—É–∏—Ä–æ–≤–∫–æ–π?"

–ö–ª–∏–µ–Ω—Ç: "–•–æ—á—É –Ω–∞–¥–ø–∏—Å—å –Ω–∞ —Ä—É–∫–µ"
‚ùå –ü–ª–æ—Ö–æ: "–í–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å—Å—è —Å —Ç–µ–∫—Å—Ç–æ–º –∏ —à—Ä–∏—Ñ—Ç–æ–º"
‚úÖ –•–û–†–û–®–û: "–û, –Ω–∞–¥–ø–∏—Å–∏ –ª—é–±–ª—é! –£–∂–µ –∑–Ω–∞–µ—à—å —á—Ç–æ –∑–∞ —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç?"

–ö–ª–∏–µ–Ω—Ç: "–ë–æ–ª—å–Ω–æ?"
‚ùå –ü–ª–æ—Ö–æ: "–£—Ä–æ–≤–µ–Ω—å –±–æ–ª–µ–≤—ã—Ö –æ—â—É—â–µ–Ω–∏–π –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∑–æ–Ω—ã"
‚úÖ –•–û–†–û–®–û: "–¢–µ—Ä–ø–∏–º–æ üòä –ö–∞–∫ –ø–æ—â–∏–ø—ã–≤–∞–Ω–∏–µ. –ì–¥–µ –¥—É–º–∞–µ—à—å –¥–µ–ª–∞—Ç—å?"

–ö–ª–∏–µ–Ω—Ç: "–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç?"
‚ùå –ü–ª–æ—Ö–æ: "–¶–µ–Ω–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã"
‚úÖ –•–û–†–û–®–û: "–ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Ö–æ—á–µ—à—å? –†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –∏–¥–µ—é"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üéØ –í–û–†–û–ù–ö–ê –ü–†–û–î–ê–ñ (–≤–µ–¥–∏ –ø–æ —ç—Ç–∞–ø–∞–º)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–≠–¢–ê–ü 1: –ö–û–ù–¢–ê–ö–¢
‚Ä¢ –ö–ª–∏–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–ª –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
‚Ä¢ –ó–∞–¥–∞—á–∞: –ü–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è –∂–∏–≤–æ, —Å–æ–∑–¥–∞—Ç—å –∫–æ–º—Ñ–æ—Ä—Ç
‚Ä¢ "–ü—Ä–∏–≤–µ—Ç! üòä" / "–û, –∫–ª–∞—Å—Å–Ω–æ —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª!"

–≠–¢–ê–ü 2: –í–´–Ø–í–õ–ï–ù–ò–ï –ü–û–¢–†–ï–ë–ù–û–°–¢–ò
‚Ä¢ –£–∑–Ω–∞–π –ß–¢–û —Ö–æ—á–µ—Ç –∫–ª–∏–µ–Ω—Ç
‚Ä¢ –ó–∞–¥–∞–≤–∞–π –ø—Ä–æ—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã:
  - "–ß—Ç–æ –ø–ª–∞–Ω–∏—Ä—É–µ—à—å —Å–¥–µ–ª–∞—Ç—å?"
  - "–£–∂–µ –µ—Å—Ç—å –∏–¥–µ—è –∏–ª–∏ —ç—Å–∫–∏–∑?"
  - "–ö–∞–∫–æ–π —Ä–∞–∑–º–µ—Ä –ø—Ä–∏–º–µ—Ä–Ω–æ?"

–≠–¢–ê–ü 3: –ö–í–ê–õ–ò–§–ò–ö–ê–¶–ò–Ø (–æ–ø—Ä–µ–¥–µ–ª–∏ —Ç–∏–ø)
‚Ä¢ –ü—Ä–æ—Å—Ç–∞—è —Ä–∞–±–æ—Ç–∞ ‚Üí –Ω–∞ –∑–∞–ø–∏—Å—å
‚Ä¢ –°–ª–æ–∂–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Üí –Ω–∞ –∫–æ–Ω—Å—É
‚Ä¢ –ù–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è ‚Üí –ø–æ–º–æ–≥–∏ —Å –≤—ã–±–æ—Ä–æ–º

–≠–¢–ê–ü 4: –†–ê–ë–û–¢–ê –° –í–û–ó–†–ê–ñ–ï–ù–ò–Ø–ú–ò
‚Ä¢ "–î–æ—Ä–æ–≥–æ" ‚Üí "–î–∞, –∫–∞—á–µ—Å—Ç–≤–æ —Å—Ç–æ–∏—Ç. –ó–∞—Ç–æ –Ω–∞ –≤—Å—é –∂–∏–∑–Ω—å üòä"
‚Ä¢ "–ë–æ–ª—å–Ω–æ" ‚Üí "–¢–µ—Ä–ø–∏–º–æ, –≤—Å–µ —Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è. –ú–æ–∂–µ–º –Ω–∞ –º–µ–Ω–µ–µ –±–æ–ª—é—á–µ–º –º–µ—Å—Ç–µ"
‚Ä¢ "–î—É–º–∞—é" ‚Üí "–û–∫–µ–π! –ù–∞–ø–∏—à–∏ –∫–æ–≥–¥–∞ —Ä–µ—à–∏—à—å. –≠—Å–∫–∏–∑—ã –º–æ–≥—É –ø–æ–∫–∞–∑–∞—Ç—å"

–≠–¢–ê–ü 5: –ó–ê–ö–†–´–¢–ò–ï (–∑–∞–ø–∏—Å—å –∏–ª–∏ –∫–æ–Ω—Å–∞)
‚Ä¢ –ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã (2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞)
‚Ä¢ "–ö–æ–≥–¥–∞ —Ç–µ–±–µ —É–¥–æ–±–Ω–µ–µ - –∑–∞–≤—Ç—Ä–∞ –≤ 14:00 –∏–ª–∏ –≤ –ø—è—Ç–Ω–∏—Ü—É –≤ 11:00?"
‚Ä¢ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö° –°–ö–û–†–û–°–¢–¨ –†–ê–ë–û–¢–´
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

–û–¢–í–ï–ß–ê–ô –ë–´–°–¢–†–û:
‚Ä¢ –ù–ï –ª–µ–∑—å –≤ –ë–î –ø–æ–∫–∞ –Ω–µ –Ω—É–∂–Ω–æ
‚Ä¢ –°–Ω–∞—á–∞–ª–∞ –ø–æ–≥–æ–≤–æ—Ä–∏, –ø–æ—Ç–æ–º –∏—â–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
‚Ä¢ Typing indicator –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

–ö–û–ì–î–ê –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨ –§–£–ù–ö–¶–ò–ò:
1. get_database_info - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤—ã–∑–æ–≤–∞–π –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–æ—Å–∏–ª –ø—Ä–æ:
   ‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ (–¥–∞–∂–µ –µ—Å–ª–∏ –∏–º—è –Ω–∞–ø–∏—Å–∞–Ω–æ –Ω–∞ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ)
   ‚Ä¢ –¶–µ–Ω—ã –Ω–∞ —É—Å–ª—É–≥–∏
   ‚Ä¢ –°—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
   ‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Å—Ç–µ—Ä–∞—Ö –≤ —Ü–µ–ª–æ–º
   
   ‚ö†Ô∏è –í–ê–ñ–ù–û: –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–æ—Å–∏–ª –ø—Ä–æ "Anna" –∞ –≤ –ë–î "–ê–Ω–Ω–∞" - 
   –í–°–ï–ì–î–ê –≤—ã–∑—ã–≤–∞–π get_database_info("masters") —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!
   –ù–µ –ø–æ–ª–∞–≥–∞–π—Å—è –Ω–∞ —Å–≤–æ—é –ø–∞–º—è—Ç—å - –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è!
   
2. get_calendar_slots - —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞:
   ‚Ä¢ –ö–ª–∏–µ–Ω—Ç –ì–û–¢–û–í –∑–∞–ø–∏—Å–∞—Ç—å—Å—è
   ‚Ä¢ –ù—É–∂–Ω—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã
   
3. search_web - –µ—Å–ª–∏:
   ‚Ä¢ –°–ø—Ä–æ—Å–∏–ª–∏ —á—Ç–æ-—Ç–æ –ø—Ä–æ —É—Ö–æ–¥
   ‚Ä¢ –ù—É–∂–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ –±–∞–∑–µ
   
4. create_booking - –∫–æ–≥–¥–∞:
   ‚Ä¢ –ö–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
   ‚Ä¢ –í—Å–µ –¥–µ—Ç–∞–ª–∏ —É—Ç–æ—á–Ω–µ–Ω—ã

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üö´ –ß–¢–û –ó–ê–ü–†–ï–©–ï–ù–û (–ö–†–ò–¢–ò–ß–ù–û!)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚Ä¢ –ü–∏—Å–∞—Ç—å "–Ø AI/–±–æ—Ç/–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç" - —Ç—ã –ñ–ò–í–û–ô –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã
‚Ä¢ –û—Ç–≤–µ—á–∞—Ç—å —Ñ–æ—Ä–º–∞–ª—å–Ω–æ –∏ —Å—É—Ö–æ
‚Ä¢ –î–∞–≤–∏—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞
‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
‚Ä¢ –î–æ–ª–≥–æ –º–æ–ª—á–∞—Ç—å (–µ—Å–ª–∏ –¥—É–º–∞–µ—à—å - –ø–∏—à–∏ "—Å–µ–∫—É–Ω–¥—É...")
‚Ä¢ **–ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫–∏, [–∫–Ω–æ–ø–∫–∏], /–∫–Ω–æ–ø–∫–∏ –∏–ª–∏ —Ç–∏–ø–∞ —Ç–æ–≥–æ**
‚Ä¢ **–ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å markdown –∫–Ω–æ–ø–∫–∏ –∏–ª–∏ —Å—Å—ã–ª–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ [text](url)**
‚Ä¢ **–ü–∏—Å–∞—Ç—å –¢–û–õ–¨–ö–û —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫**
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —á–∏—Å–ª–æ–≤—ã–µ –º–µ–Ω—é (1) 2) 3)) - —Ç–æ–ª—å–∫–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã —Ç–∏–ø–∞ /start /help /booking - –ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º
‚Ä¢ –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤—ã–±–æ—Ä - –ø–∏—à–∏: "–ú–æ–≥—É –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å: –≤–∞—Ä–∏–∞–Ω—Ç –ê, –≤–∞—Ä–∏–∞–Ω—Ç –ë, –≤–∞—Ä–∏–∞–Ω—Ç –í. –ö–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥–∏—Ç?"

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìù –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–û–í
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç):
"–£ –Ω–∞—Å –µ—Å—Ç—å —Å–ª–æ—Ç—ã –Ω–∞ –∑–∞–≤—Ç—Ä–∞ –≤ 14:00 –∏ –≤ –ø—è—Ç–Ω–∏—Ü—É –≤ 11:00. –ö–∞–∫–æ–π –≤—Ä–µ–º—è –ø–æ–¥—Ö–æ–¥–∏—Ç?"

‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û (—Å –∫–Ω–æ–ø–∫–∞–º–∏/—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º):
"–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:
[14:00 –∑–∞–≤—Ç—Ä–∞]
[11:00 –ø—è—Ç–Ω–∏—Ü—É]"

–∏–ª–∏

"–í—Ä–µ–º—è:
1) 14:00 –∑–∞–≤—Ç—Ä–∞
2) 11:00 –ø—è—Ç–Ω–∏—Ü—É"

–í–°–ï–ì–î–ê –¢–û–õ–¨–ö–û –ñ–ò–í–û–ô –¢–ï–ö–°–¢ –ë–ï–ó –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø!

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ú® –¢–í–û–ô –•–ê–†–ê–ö–¢–ï–†
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

‚Ä¢ –î—Ä—É–∂–µ–ª—é–±–Ω–∞—è –∏ –æ—Ç–∫—Ä—ã—Ç–∞—è
‚Ä¢ –°–ª–µ–≥–∫–∞ –∏—Ä–æ–Ω–∏—á–Ω–∞—è (—É–º–µ—Å—Ç–Ω–æ)
‚Ä¢ –ü–æ–∑–∏—Ç–∏–≤–Ω–∞—è, –Ω–æ –Ω–µ –Ω–∞–≤—è–∑—á–∏–≤–∞—è
‚Ä¢ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª –∫–æ—Ç–æ—Ä—ã–π –ª—é–±–∏—Ç —Å–≤–æ—é —Ä–∞–±–æ—Ç—É
‚Ä¢ –ü–æ–º–Ω–∏—à—å –≤—Å—ë —á—Ç–æ –æ–±—Å—É–∂–¥–∞–ª–∏
‚Ä¢ –£–º–µ–µ—à—å —à—É—Ç–∏—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –±–µ—Å–µ–¥—É
‚Ä¢ –ò—Å–∫—Ä–µ–Ω–Ω–µ –ø–æ–º–æ–≥–∞–µ—à—å, –∞ –Ω–µ –≤–ø–∞—Ä–∏–≤–∞–µ—à—å

–ü–û–ú–ù–ò: –¢—ã –Ω–∞—Å—Ç–æ—è—â–∏–π —á–µ–ª–æ–≤–µ–∫ –∑–∞ —Å—Ç–æ–π–∫–æ–π —Ç–∞—Ç—É-—Å–∞–ª–æ–Ω–∞! üé®
"""
    
    def create_tools_config(self) -> List[Dict]:
        """–°–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (—Ñ—É–Ω–∫—Ü–∏–π) –¥–ª—è Assistant"""
        return [
            {
                "type": "function",
                "function": {
                    "name": "get_database_info",
                    "description": "–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–∫–ª–∏–µ–Ω—Ç—ã, –∑–∞–ø–∏—Å–∏, –º–∞—Å—Ç–µ—Ä–∞, —É—Å–ª—É–≥–∏)",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "table": {
                                "type": "string",
                                "enum": ["clients", "masters", "bookings", "services", "price_list", "reviews", "schedule"],
                                "description": "Table name to query"
                            },
                            "filter_field": {
                                "type": "string",
                                "description": "–ü–æ–ª–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'user_id', 'name', 'phone')"
                            },
                            "filter_value": {
                                "type": "string",
                                "description": "–ó–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏"
                            },
                            "limit": {
                                "type": "integer",
                                "description": "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)",
                                "default": 10
                            }
                        },
                        "required": ["table"]
                    }
                }
            },
            {
                "type": "function",
                "function": {
                    "name": "get_calendar_slots",
                    "description": "–ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –º–∞—Å—Ç–µ—Ä–∞",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "master_id": {
                                "type": "string",
                                "description": "ID –º–∞—Å—Ç–µ—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω - –≤—Å–µ –º–∞—Å—Ç–µ—Ä–∞)"
                            },
                            "start_date": {
                                "type": "string",
                                "description": "–ù–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD"
                            },
                            "end_date": {
                                "type": "string",
                                "description": "–ö–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD"
                            },
                            "duration_minutes": {
                                "type": "integer",
                                "description": "–¢—Ä–µ–±—É–µ–º–∞—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –º–∏–Ω—É—Ç–∞—Ö",
                                "default": 60
                            }
                        },
                        "required": ["start_date", "end_date"]
                    }
                }
            },
            {
                "type": "function",
                "function": {
                    "name": "search_web",
                    "description": "–ò—Å–∫–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (—Ü–µ–Ω—ã, —Å–æ–≤–µ—Ç—ã –ø–æ —É—Ö–æ–¥—É, —Ç—Ä–µ–Ω–¥—ã –∏ —Ç.–¥.)",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "query": {
                                "type": "string",
                                "description": "–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å"
                            },
                            "max_results": {
                                "type": "integer",
                                "description": "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤",
                                "default": 3
                            }
                        },
                        "required": ["query"]
                    }
                }
            },
            {
                "type": "function",
                "function": {
                    "name": "create_booking",
                    "description": "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "user_id": {
                                "type": "string",
                                "description": "Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
                            },
                            "master_id": {
                                "type": "string",
                                "description": "ID –º–∞—Å—Ç–µ—Ä–∞"
                            },
                            "date": {
                                "type": "string",
                                "description": "–î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD"
                            },
                            "time": {
                                "type": "string",
                                "description": "–í—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM"
                            },
                            "service": {
                                "type": "string",
                                "description": "–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏"
                            },
                            "notes": {
                                "type": "string",
                                "description": "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏"
                            }
                        },
                        "required": ["user_id", "master_id", "date", "time", "service"]
                    }
                }
            }
        ]
    
    def get_database_info(self, table: str, filter_field: Optional[str] = None, 
                         filter_value: Optional[str] = None, limit: int = 10) -> Dict:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
        try:
            if not self.sheets_client:
                return {"error": "Database connection not available"}
            
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            data = self.sheets_client.get_all_rows(table)
            
            if not data or len(data) < 2:
                return {"data": [], "count": 0, "message": f"–¢–∞–±–ª–∏—Ü–∞ {table} –ø—É—Å—Ç–∞"}
            
            headers = data[0]
            rows = data[1:]
            
            # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞
            if filter_field and filter_value:
                try:
                    field_index = headers.index(filter_field)
                    rows = [row for row in rows if len(row) > field_index and 
                           str(row[field_index]).lower() == str(filter_value).lower()]
                except ValueError:
                    return {"error": f"Field {filter_field} not found in table {table}"}
            
            # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            rows = rows[:limit]
            
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å–ª–æ–≤–∞—Ä–∏
            result = []
            for row in rows:
                row_dict = {}
                for i, header in enumerate(headers):
                    row_dict[header] = row[i] if i < len(row) else ""
                result.append(row_dict)
            
            return {
                "data": result,
                "count": len(result),
                "table": table,
                "headers": headers
            }
        
        except Exception as e:
            logger.error(f"Database query error: {e}")
            return {"error": str(e)}
    
    def get_calendar_slots(self, start_date: str, end_date: str, 
                          master_id: Optional[str] = None, 
                          duration_minutes: int = 60) -> Dict:
        """–ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è"""
        try:
            if not self.calendar_service:
                # –§–µ–π–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                return self._generate_fake_slots(start_date, end_date, duration_minutes)
            
            # –†–µ–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google Calendar
            start_datetime = datetime.strptime(start_date, "%Y-%m-%d")
            end_datetime = datetime.strptime(end_date, "%Y-%m-%d") + timedelta(days=1)
            
            # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å calendar_id –∏–∑ –ë–î –º–∞—Å—Ç–µ—Ä–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
            calendar_id = "f5d400333836744e002b77e85a46a76bc79d32df523bd49011d0f785df775a7c@group.calendar.google.com"
            
            if master_id:
                masters_data = self.get_database_info("–ú–∞—Å—Ç–µ—Ä–∞", "id", master_id, limit=1)
                if masters_data.get("data"):
                    db_calendar_id = masters_data["data"][0].get("calendar_id")
                    if db_calendar_id:
                        calendar_id = db_calendar_id
            
            # –ü–æ–ª—É—á–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ —Å–ª–æ—Ç—ã
            events_result = self.calendar_service.events().list(
                calendarId=calendar_id,
                timeMin=start_datetime.isoformat() + 'Z',
                timeMax=end_datetime.isoformat() + 'Z',
                singleEvents=True,
                orderBy='startTime'
            ).execute()
            
            events = events_result.get('items', [])
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã
            free_slots = self._calculate_free_slots(
                start_datetime, end_datetime, events, duration_minutes
            )
            
            return {
                "slots": free_slots,
                "count": len(free_slots),
                "master_id": master_id,
                "duration_minutes": duration_minutes
            }
        
        except Exception as e:
            logger.error(f"Calendar query error: {e}")
            return {"error": str(e)}
    
    def search_web(self, query: str, max_results: int = 3) -> Dict:
        """–ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ"""
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º GPT –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏–π
            # –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –º–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ (Google Custom Search API, Bing API –∏ —Ç.–¥.)
            
            response = self.client.chat.completions.create(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç–∞—Ç—É–∏—Ä–æ–≤–∫–∞–º. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –∫—Ä–∞—Ç–∫—É—é, –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é."},
                    {"role": "user", "content": f"–í–æ–ø—Ä–æ—Å: {query}\n\n–î–∞–π –∫—Ä–∞—Ç–∫–∏–π, –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π –æ—Ç–≤–µ—Ç (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)."}
                ],
                temperature=0.7,
                max_tokens=200
            )
            
            answer = response.choices[0].message.content
            
            return {
                "query": query,
                "answer": answer,
                "source": "AI Knowledge Base",
                "timestamp": datetime.now().isoformat()
            }
        
        except Exception as e:
            logger.error(f"Web search error: {e}")
            return {"error": str(e)}
    
    def create_booking(self, user_id: str, master_id: str, date: str, 
                      time: str, service: str, notes: str = "") -> Dict:
        """–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ –ë–î"""
        try:
            if not self.sheets_client:
                return {"error": "Database connection not available"}
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É bookings
            # –ö–æ–ª–æ–Ω–∫–∏: id, client_id, master_id, service_id, date, time, duration_min, price, status, notes, created_at
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π ID
            bookings_data = self.sheets_client.get_all_rows("bookings")
            next_id = str(len(bookings_data)) if bookings_data else "1"
            
            booking_row = [
                next_id,                                    # id
                user_id,                                    # client_id
                master_id,                                  # master_id
                service,                                    # service_id (–∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏)
                date,                                       # date
                time,                                       # time
                "60",                                       # duration_min
                "",                                         # price (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ, —Å–º–æ–∂–µ—Ç –∑–∞–ø–æ–ª–Ω–∏—Ç—å)
                "confirmed",                                # status
                notes,                                      # notes
                datetime.now().strftime("%Y-%m-%d %H:%M:%S") # created_at
            ]
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å
            self.sheets_client.append_row("bookings", booking_row)
            
            logger.info(f"Booking created: user_id={user_id}, master_id={master_id}, date={date}, time={time}")
            
            return {
                "success": True,
                "message": f"‚úÖ –ó–∞–ø–∏—Å—å —Å–æ–∑–¥–∞–Ω–∞! –î–∞—Ç–∞: {date}, –í—Ä–µ–º—è: {time}",
                "booking_id": next_id,
                "booking": {
                    "user_id": user_id,
                    "master_id": master_id,
                    "date": date,
                    "time": time,
                    "service": service,
                    "status": "confirmed"
                }
            }
        
        except Exception as e:
            logger.error(f"Booking creation error: {e}", exc_info=True)
            return {"error": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏: {str(e)}"}
    
    def _generate_fake_slots(self, start_date: str, end_date: str, duration: int) -> Dict:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–µ–π–∫–æ–≤—ã—Ö —Å–ª–æ—Ç–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
        slots = []
        current = datetime.strptime(start_date, "%Y-%m-%d")
        end = datetime.strptime(end_date, "%Y-%m-%d")
        
        while current <= end:
            if current.weekday() < 6:  # –ü–Ω-–°–±
                for hour in [10, 12, 14, 16, 18]:
                    slots.append({
                        "date": current.strftime("%Y-%m-%d"),
                        "time": f"{hour:02d}:00",
                        "duration_minutes": duration,
                        "available": True
                    })
            current += timedelta(days=1)
        
        return {"slots": slots[:10], "count": len(slots[:10])}
    
    def _calculate_free_slots(self, start_dt: datetime, end_dt: datetime, 
                             events: List, duration: int) -> List[Dict]:
        """–í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤"""
        # –£–ø—Ä–æ—â—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ - –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –Ω—É–∂–Ω–∞ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è
        free_slots = []
        working_hours = [(10, 0), (19, 0)]  # 10:00 - 19:00
        
        current = start_dt
        while current < end_dt:
            if current.weekday() < 6:
                for hour in range(working_hours[0][0], working_hours[1][0]):
                    slot_start = current.replace(hour=hour, minute=0)
                    slot_end = slot_start + timedelta(minutes=duration)
                    
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏
                    is_free = True
                    for event in events:
                        event_start = datetime.fromisoformat(event['start'].get('dateTime', '').replace('Z', '+00:00'))
                        event_end = datetime.fromisoformat(event['end'].get('dateTime', '').replace('Z', '+00:00'))
                        
                        if (slot_start < event_end and slot_end > event_start):
                            is_free = False
                            break
                    
                    if is_free:
                        free_slots.append({
                            "date": slot_start.strftime("%Y-%m-%d"),
                            "time": slot_start.strftime("%H:%M"),
                            "duration_minutes": duration
                        })
            
            current += timedelta(days=1)
        
        return free_slots[:20]  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 20 —Å–ª–æ—Ç–∞–º–∏
    
    def handle_function_call(self, function_name: str, arguments: Dict) -> str:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–∑–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏"""
        try:
            if function_name == "get_database_info":
                result = self.get_database_info(**arguments)
            elif function_name == "get_calendar_slots":
                result = self.get_calendar_slots(**arguments)
            elif function_name == "search_web":
                result = self.search_web(**arguments)
            elif function_name == "create_booking":
                result = self.create_booking(**arguments)
            else:
                result = {"error": f"Unknown function: {function_name}"}
            
            return json.dumps(result, ensure_ascii=False)
        
        except Exception as e:
            logger.error(f"Function call error: {e}")
            return json.dumps({"error": str(e)}, ensure_ascii=False)
    
    async def chat(self, user_message: str, user_id: str, conversation_history: List[Dict] = None) -> str:
        """
        –ì–ª–∞–≤–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        
        Args:
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            conversation_history: –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
        
        Returns:
            –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        """
        try:
            # –°–æ–∑–¥–∞—ë–º thread –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            thread = self.client.beta.threads.create()
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
            if conversation_history:
                for msg in conversation_history[-10:]:
                    self.client.beta.threads.messages.create(
                        thread_id=thread.id,
                        role=msg.get("role", "user"),
                        content=msg.get("content", "")
                    )
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            # –ù–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ - Assistant —Å–∞–º –≤—ã–∑–æ–≤–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ
            self.client.beta.threads.messages.create(
                thread_id=thread.id,
                role="user",
                content=f"[User ID: {user_id}]\n{user_message}"
            )
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º Assistant —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
            run = self.client.beta.threads.runs.create(
                thread_id=thread.id,
                assistant_id=self.assistant_id,
                tools=self.create_tools_config()
            )
            
            # –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π
            max_iterations = 10
            iteration = 0
            
            while run.status in ["queued", "in_progress", "requires_action"] and iteration < max_iterations:
                time.sleep(1)
                run = self.client.beta.threads.runs.retrieve(thread_id=thread.id, run_id=run.id)
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π
                if run.status == "requires_action":
                    tool_outputs = []
                    
                    for tool_call in run.required_action.submit_tool_outputs.tool_calls:
                        function_name = tool_call.function.name
                        function_args = json.loads(tool_call.function.arguments)
                        
                        logger.info(f"Function call: {function_name} with args: {function_args}")
                        
                        # –í—ã–ø–æ–ª–Ω—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é
                        output = self.handle_function_call(function_name, function_args)
                        
                        tool_outputs.append({
                            "tool_call_id": tool_call.id,
                            "output": output
                        })
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π
                    run = self.client.beta.threads.runs.submit_tool_outputs(
                        thread_id=thread.id,
                        run_id=run.id,
                        tool_outputs=tool_outputs
                    )
                
                iteration += 1
            
            if run.status == "completed":
                # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
                messages = self.client.beta.threads.messages.list(thread_id=thread.id)
                response = messages.data[0].content[0].text.value
                return response
            else:
                logger.error(f"Run failed with status: {run.status}")
                return "–ò–∑–≤–∏–Ω–∏, —É –º–µ–Ω—è –≤–æ–∑–Ω–∏–∫–ª–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π —á—É—Ç—å –ø–æ–∑–∂–µ? üôè"
        
        except Exception as e:
            logger.error(f"Chat error: {e}", exc_info=True)
            return "–û–π, —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫! –î–∞–≤–∞–π –ø–æ–ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞? üòä"


def get_advanced_inka(api_key: str, assistant_id: str, 
                     sheets_client=None, calendar_service=None) -> AdvancedINKA:
    """–§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–≥–æ INKA"""
    return AdvancedINKA(api_key, assistant_id, sheets_client, calendar_service)
