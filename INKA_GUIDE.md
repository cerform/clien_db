# üé® INKA - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ç–∞—Ç—É-–º–∞—Å—Ç–µ—Ä–∞ –ê–Ω–∏

##Ê¶ÇËø∞ (–û–±–∑–æ—Ä)

**INKA** ‚Äî —ç—Ç–æ —Ç—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è Telegram-–±–æ—Ç–∞ —Å–∏—Å—Ç–µ–º—ã –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞—Ç—É-—Å–∞–ª–æ–Ω–∞.

–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: **S1 ‚Üí S2 ‚Üí S3**

---

## üî∑ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ S1 ‚Üí S2 ‚Üí S3

### **S1 - –ö–õ–ê–°–°–ò–§–ò–ö–ê–¢–û–†** (Classification)
- **–í—Ö–æ–¥:** –¢–µ–∫—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + –∫–æ–Ω—Ç–µ–∫—Å—Ç
- **–í—ã—Ö–æ–¥:** **JSON** —Å –º–∞—Ä—à—Ä—É—Ç–æ–º –∏ —ç—Ç–∞–ø–æ–º
- **–ó–∞–¥–∞—á–∞:** –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```json
{
  "route": "booking",
  "stage": "offer_slots",
  "booking_type": "tattoo",
  "intent_summary": "–ö–ª–∏–µ–Ω—Ç —Ö–æ—á–µ—Ç –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ç–∞—Ç—É–∏—Ä–æ–≤–∫—É"
}
```

**–î–æ–ø—É—Å—Ç–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏—è |
|----------|----------|
| `route` | `booking`, `booking_confirm`, `booking_reschedule`, `consultation`, `info`, `other` |
| `stage` | `offer_slots`, `waiting_client_choice`, `confirming_choice`, `completed`, `error`, `none` |
| `booking_type` | `tattoo`, `consultation`, `walk-in`, `none` |

---

### **S2 - BOOKING ENGINE** (Booking Management)
- **–í—Ö–æ–¥:** `stage` + `available_slots` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **–í—ã—Ö–æ–¥:** **–¢–ï–ö–°–¢** –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
- **–ó–∞–¥–∞—á–∞:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏

#### stage = `offer_slots`
–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ—Ç—ã:

```
–í–æ—Ç —Å–≤–æ–±–æ–¥–Ω—ã–µ –æ–∫–Ω–∞:

‚Ä¢ 12.12 –≤ 14:00
‚Ä¢ 12.12 –≤ 15:00
‚Ä¢ 13.12 –≤ 10:00

–ù–∞–∂–º–∏ –Ω–∞ —É–¥–æ–±–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –∏ —è –∑–∞–∫—Ä–µ–ø–ª—é –≤—Ä–µ–º—è.
```

#### stage = `confirming_choice`
–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä —Å–ª–æ—Ç–∞:

```
–û—Ç–ª–∏—á–Ω–æ, –∑–∞–∫—Ä–µ–ø–∏–ª–∞ –∑–∞ —Ç–æ–±–æ–π 12.12 –≤ 14:00.
–°–∫–æ—Ä–æ –ø—Ä–∏—à–ª—é –¥–µ—Ç–∞–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏.
```

---

### **S3 - –ü–û–°–õ–ï –ë–†–û–ù–ò** (Post-Booking)
- **–í—Ö–æ–¥:** –¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è + –¥–∞–Ω–Ω—ã–µ –æ –±—Ä–æ–Ω–∏
- **–í—ã—Ö–æ–¥:** **–¢–ï–ö–°–¢** - –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ/–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- **–ó–∞–¥–∞—á–∞:** –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

```
–û—Ç–ª–∏—á–Ω–æ! –ó–∞–∫—Ä–µ–ø–∏–ª–∞ –∑–∞ —Ç–æ–±–æ–π 12.12 –≤ 14:00.
–°–∫–æ—Ä–æ –ø—Ä–∏—à–ª—é –¥–µ—Ç–∞–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏.
```

---

## üìã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–¥–µ

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

```python
from src.ai.inka import get_inka_processor

inka = get_inka_processor(api_key="sk-...")
```

### S1 - –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è

```python
classification = inka.stage_1_classify(
    user_message="–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ç–∞—Ç—É–∏—Ä–æ–≤–∫—É",
    context={
        "client_status": "regular",
        "has_active_booking": False
    }
)

route = classification["route"]  # "booking"
stage = classification["stage"]  # "offer_slots"
```

### S2 - Booking Engine

```python
# –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–ª–æ—Ç–æ–≤
text = inka.stage_2_booking_engine(
    stage="offer_slots",
    available_slots=[
        {"date": "2025-12-12", "start_time": "14:00", "end_time": "15:00"},
        {"date": "2025-12-13", "start_time": "10:00", "end_time": "11:00"}
    ]
)

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞
text = inka.stage_2_booking_engine(
    stage="confirming_choice",
    slot_taken=False,
    booking_info={"date": "2025-12-12", "time": "14:00"}
)
```

### S3 - Post-Booking

```python
# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
text = inka.stage_3_post_booking(
    "confirm",
    booking_data={"date": "2025-12-12", "time": "14:00"}
)

# –û—Ç–º–µ–Ω–∞
text = inka.stage_3_post_booking("cancel")

# –ü–µ—Ä–µ–Ω–æ—Å
text = inka.stage_3_post_booking("reschedule")
```

---

## üö® –ó–ê–ü–†–ï–¢–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø

‚ùå **S1 –ù–ï –î–û–õ–ñ–ù–ê:**
- –ü—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç—ã
- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –ë–î

‚ùå **S2 –ù–ï –î–û–õ–ñ–ù–ê:**
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JSON
- –ú–µ–Ω—è—Ç—å –≤—Ä–µ–º—è —Å–ª–æ—Ç–æ–≤
- –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –ë–î

‚ùå **S3 –ù–ï –î–û–õ–ñ–ù–ê:**
- –î–∞–≤–∞—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã
- –û–±—Å—É–∂–¥–∞—Ç—å —Ü–µ–Ω—ã
- –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JSON

---

## üìù –°–¢–ò–õ–¨ INKA

- ‚úÖ –ö–æ—Ä–æ—Ç–∫–æ
- ‚úÖ –ñ–∏–≤–æ
- ‚úÖ –¢–µ–ø–ª–æ
- ‚úÖ –£–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ
- ‚úÖ –ë–µ–∑ –¥–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ –ë–µ–∑ –ø—Ä–æ–¥–∞–∂–Ω–æ–≥–æ —Ç–æ–Ω–∞
- ‚ùå –ë–µ–∑ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤
- ‚ùå –ë–µ–∑ –≤—ã–¥—É–º–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫

### client_handler.py

```python
from src.ai.inka import get_inka_processor

@router.message(F.text == "üìÖ –ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ –ø—Ä–∏–µ–º")
async def book_appointment(message: Message, state: FSMContext):
    """–ò—Å–ø–æ–ª—å–∑—É–µ—Ç INKA S1 –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏"""
    inka = get_inka_processor(config.openai_api_key)
    
    classification = inka.stage_1_classify(
        message.text,
        context={
            "client_status": "regular",
            "has_active_booking": False
        }
    )
    
    if classification["route"] == "booking":
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º INKA S2 –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å–ª–æ—Ç–æ–≤
        text = inka.stage_2_booking_engine(
            stage="offer_slots",
            available_slots=slots
        )
        await message.answer(text)
```

---

## üß™ –ü—Ä–∏–º–µ—Ä—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç S1

```python
inka = get_inka_processor("sk-...")

# –¢–µ—Å—Ç 1: –ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É
result = inka.stage_1_classify("–•–æ—á—É –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ç–∞—Ç—É–∏—Ä–æ–≤–∫—É")
assert result["route"] == "booking"
assert result["stage"] == "offer_slots"

# –¢–µ—Å—Ç 2: –í–æ–ø—Ä–æ—Å –æ —Ü–µ–Ω–µ
result = inka.stage_1_classify("–°–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç –Ω–µ–±–æ–ª—å—à–∞—è —Ç–∞—Ç—É–∏—Ä–æ–≤–∫–∞?")
assert result["route"] == "info"

# –¢–µ—Å—Ç 3: –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
result = inka.stage_1_classify("–Ø —Ö–æ—á—É –æ–±—Å—É–¥–∏—Ç—å –∏–¥–µ—é –¥–ª—è —Ç–∞—Ç—É–∏—Ä–æ–≤–∫–∏")
assert result["route"] == "consultation"
```

### –¢–µ—Å—Ç S2

```python
# –¢–µ—Å—Ç —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ —Å–ª–æ—Ç–∞–º–∏
text = inka.stage_2_booking_engine(
    stage="offer_slots",
    available_slots=[...]
)
assert "12.12" in text
assert "14:00" in text

# –¢–µ—Å—Ç –±–µ–∑ —Å–ª–æ—Ç–æ–≤
text = inka.stage_2_booking_engine(
    stage="offer_slots",
    available_slots=[]
)
assert "—Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ–∫–æ–Ω" in text
```

---

## üìä Flow-–¥–∏–∞–≥—Ä–∞–º–º–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    ‚Üì
[S1 –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä]
    ‚Üì
    ‚îú‚îÄ route="booking" ‚Üí S2 (offer_slots)
    ‚îú‚îÄ route="info" ‚Üí –æ—Ç–≤–µ—Ç –æ —Ü–µ–Ω–µ/—É—Ö–æ–¥–µ
    ‚îú‚îÄ route="consultation" ‚Üí –æ—Ç–≤–µ—Ç –æ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏
    ‚îî‚îÄ route="other" ‚Üí –æ—Ç–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    ‚Üì
[S2 Booking Engine]
    ‚Üì
    ‚îú‚îÄ stage="offer_slots" ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å —Å–ª–æ—Ç—ã
    ‚îú‚îÄ stage="confirming_choice" ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–ª–æ—Ç
    ‚Üì
[S3 Post-Booking]
    ‚Üì
    ‚Üí –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
```

---

## üéØ –ò—Ç–æ–≥–æ

**INKA** ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è:
- ‚úÖ –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–π (S1)
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (S2)
- ‚úÖ –ü–æ—Å—Ç–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π (S3)

**–ü—Ä–∞–≤–∏–ª–æ:** –ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö:
- S1 ‚Üí JSON
- S2 ‚Üí –¢–ï–ö–°–¢
- S3 ‚Üí –¢–ï–ö–°–¢
