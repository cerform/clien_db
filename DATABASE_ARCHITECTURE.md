# 📊 Архитектура и Структура БД

## 🏗️ Общая архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                     Google Sheets (облачная БД)                 │
│                                                                  │
│  1gU-8cqVOiGHcgY823vQeC6JX8oZfLOrJ_l7OjRqqHiY                   │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 │
        ┌────────────────────────┼────────────────────────┐
        │                        │                        │
        ▼                        ▼                        ▼
    ┌────────┐             ┌───────────┐           ┌─────────┐
    │ Лист 1 │             │  Лист 2   │           │ Лист 3  │
    │Мастера │             │ Клиенты   │           │ Записи  │
    └────────┘             └───────────┘           └─────────┘
        │                        │                        │
        │ (10 колонок)          │ (10 колонок)          │ (12 колонок)
        │                        │                        │
        ▼                        ▼                        ▼
    ┌────────┐             ┌───────────┐           ┌─────────┐
    │ ID     │             │ ID        │           │ ID      │
    │ Имя    │             │ Telegram  │           │ Клиент  │
    │Специа- │             │ ID        │           │ Мастер  │
    │льность │             │ Имя       │           │ Услуга  │
    │ Опыт   │             │ Телефон   │           │ Дата    │
    │ Рейтинг│             │ Email     │           │ Статус  │
    │Телефон │             │ Дата рег. │           │ Цена    │
    │Instagram│            │ Статус    │           │ ...     │
    │ Цена   │             │ Визитов   │           │         │
    │Статус  │             │ Потрачено │           │         │
    │Описание│             │ Примечания│           │         │
    └────────┘             └───────────┘           └─────────┘
        │                        │                        │
        │ (4 мастера)           │ (3 клиента)           │ (0)
        │ Алексей               │ Петр Иванов           │ пуста
        │ Мария                 │ Ольга Сергеева        │
        │ Иван                  │ Дмитрий Козлов        │
        │ Елена                 │                       │
        └────────────────────────────────────────────────┘


    ┌────────┐             ┌───────────┐           ┌─────────┐
    │ Лист 4 │             │  Лист 5   │           │ Лист 6  │
    │Услуги  │             │Расписание │           │ Отзывы  │
    └────────┘             └───────────┘           └─────────┘
        │                        │                        │
        │ (8 колонок)           │ (9 колонок)           │ (10 колонок)
        │                        │                        │
        ▼                        ▼                        ▼
    ┌────────┐             ┌───────────┐           ┌─────────┐
    │ ID     │             │ ID        │           │ ID      │
    │Название│             │ Мастер    │           │ Клиент  │
    │Описание│             │ Дата      │           │ Мастер  │
    │Дли-    │             │ Время     │           │ Оценка  │
    │тельность             │ начало    │           │ Текст   │
    │ Цена   │             │ Время     │           │ Дата    │
    │ Кате-  │             │ конец     │           │ ID зап. │
    │ гория  │             │ Статус    │           │ Полезно │
    │ Статус │             │Тип события│           │         │
    │Изоб-   │             │ Примечани│           │         │
    │ражение │             │          │           │         │
    └────────┘             └───────────┘           └─────────┘
        │                        │                        │
        │ (6 услуг)             │ (0) пуста             │ (0) пуста
        │ Портреты              │                       │
        │ Минимализм            │                       │
        │ Классика              │                       │
        │ Орнаменты             │                       │
        │ Малые тату            │                       │
        │ Консультация          │                       │
        └────────────────────────────────────────────────┘


    ┌────────────────┐
    │   Лист 7       │
    │ Прайс-лист    │
    └────────────────┘
            │
            │ (8 колонок)
            │
            ▼
        ┌────────────┐
        │ ID         │
        │ Мастер     │
        │ Услуга     │
        │ Цена       │
        │ Комиссия   │
        │ Доход      │
        │ Дата       │
        │ Активна    │
        │ Примечания │
        └────────────┘
            │
            │ (0) пуста
            │
            └──────────────────────────────┘
```

## 📋 Связи между листами

```
┌─────────────┐           ┌──────────┐
│  Мастера    │──────────▶│Расписание│
│             │           │          │
│ ID: 1       │─────┬────▶│Мастер:1  │
│ Имя: Алекс  │     │     │Дата:     │
│             │     │     │Время:    │
│             │     │     │Статус:   │
└─────────────┘     │     └──────────┘
                    │
                    │
┌─────────────┐     │     ┌──────────┐
│  Клиенты    │     │    ▶│ Записи   │
│             │     │     │          │
│ ID: 1001    │─────┼────▶│Клиент:1  │
│ Имя: Петр   │     │     │Мастер:1  │
│             │     │     │Статус:   │
│             │     │     │Дата:     │
└─────────────┘     │     └──────────┘
                    │            │
┌─────────────┐     │            │
│  Услуги     │     │            │ (можна добавить ссылку)
│             │─────┘            │
│ ID: 1       │                  │
│ Название:   │                  ▼
│ Портреты    │            ┌──────────┐
│ Цена: 3500  │           ▶│ Отзывы   │
│             │            │          │
└─────────────┘            │ ID запи: │
                           │ Оценка:  │
                           │ Текст:   │
                           └──────────┘

┌─────────────┐
│Прайс-лист  │ (связывает Мастера и Услуги)
│             │
│ Мастер: 1   │──▶ Алексей Волков (из Мастера)
│ Услуга: 1   │──▶ Портреты (из Услуг)
│ Цена: 3500  │
│ Комиссия: 15│
│ Доход: 2975 │
└─────────────┘
```

## 🔄 Процесс работы

```
┌─────────────────────────────────────────────┐
│     Клиент открывает Telegram бота          │
└──────────────────┬──────────────────────────┘
                   │
                   ▼
        ┌──────────────────────┐
        │ Бот загружает список │
        │  мастеров из БД      │
        │ (из листа "Мастера") │
        └──────────┬───────────┘
                   │
                   ▼
        ┌──────────────────────┐
        │  Клиент выбирает     │
        │     мастера          │
        └──────────┬───────────┘
                   │
                   ▼
        ┌──────────────────────┐
        │  Бот загружает       │
        │  доступное время из  │
        │ листа "Расписание"   │
        └──────────┬───────────┘
                   │
                   ▼
        ┌──────────────────────┐
        │  Клиент выбирает     │
        │ дату и время         │
        └──────────┬───────────┘
                   │
                   ▼
        ┌──────────────────────┐
        │  Бот создает запись  │
        │  в листе "Записи"    │
        └──────────┬───────────┘
                   │
                   ▼
        ┌──────────────────────┐
        │ Запись сохранена! ✅ │
        │ ID: 10001            │
        │ Статус: pending      │
        └──────────┬───────────┘
                   │
                   ▼
        ┌──────────────────────┐
        │  Мастер подтверждает │
        │ через бот или вручную│
        │ в Google Sheets      │
        └──────────┬───────────┘
                   │
                   ▼
        ┌──────────────────────┐
        │  Статус = confirmed  │
        │  Запись активна!     │
        └──────────┬───────────┘
                   │
                   ▼
        ┌──────────────────────┐
        │ После услуги:        │
        │ - Увеличить счетчик  │
        │   "Визитов"          │
        │ - Добавить сумму     │
        │   в "Потрачено"      │
        │ - Запросить отзыв    │
        └──────────┬───────────┘
                   │
                   ▼
        ┌──────────────────────┐
        │  Клиент оставляет    │
        │  отзыв в листе       │
        │  "Отзывы"            │
        └──────────┬───────────┘
                   │
                   ▼
        ┌──────────────────────┐
        │   Цикл завершен! ✅  │
        └──────────────────────┘
```

## 📊 Поток данных

```
┌─────────────────────┐
│   Telegram Bot      │
│  (Aiogram v3)       │
└──────────┬──────────┘
           │
           │ читает/пишет
           │
           ▼
┌─────────────────────────────────┐
│  src/db/sheets_client.py        │
│  (GoogleSheetsClient)           │
│  - append_row()                 │
│  - get_sheet_values()           │
│  - update_row()                 │
│  - find_row()                   │
│  - delete_row()                 │
└──────────┬──────────────────────┘
           │
           │ Google Sheets API
           │
           ▼
┌─────────────────────────────────┐
│  Google Sheets                  │
│  (1gU-8cqVOiGHcgY82...)         │
│                                 │
│  ├─ Мастера (4)                 │
│  ├─ Клиенты (3)                 │
│  ├─ Записи (0)                  │
│  ├─ Услуги (6)                  │
│  ├─ Расписание (0)              │
│  ├─ Отзывы (0)                  │
│  └─ Прайс-лист (0)              │
└─────────────────────────────────┘
           ▲
           │
           │ Google Calendar API
           │
           ▼
┌─────────────────────────────────┐
│  Google Calendar                │
│  (синхронизация расписания)     │
└─────────────────────────────────┘
```

## 🎯 Индексы и поиск

```
Лист "Мастера" - поиск по ID (столбец 0)
┌────────────────────────┐
│ Index │ ID │ Имя      │
├────────────────────────┤
│ 1     │ 1  │ Алексей  │ ◀── поиск("Мастера", 0, "1")
│ 2     │ 2  │ Мария    │
│ 3     │ 3  │ Иван     │
│ 4     │ 4  │ Елена    │
└────────────────────────┘

Лист "Клиенты" - поиск по Telegram ID (столбец 1)
┌────────────────────────────┐
│ Index │ ID   │ TG ID      │
├────────────────────────────┤
│ 1     │ 1001 │ 123456789  │ ◀── поиск("Клиенты", 1, "123456789")
│ 2     │ 1002 │ 987654321  │
│ 3     │ 1003 │ 555666777  │
└────────────────────────────┘

Лист "Записи" - поиск по ID Клиента (столбец 1)
┌────────────────────────┐
│ Index │ ID    │ Клиент │
├────────────────────────┤
│ 1     │ 10001 │ 123456 │ ◀── поиск("Записи", 1, "123456")
│ 2     │ 10002 │ 987654 │
└────────────────────────┘
```

## 🔐 Безопасность данных

```
┌─────────────────────────────────────┐
│  Приватные данные                   │
│  .env файл (НЕ в Git!)              │
│  credentials.json (НЕ в Git!)       │
└────────────────┬────────────────────┘
                 │
                 ▼
        ┌────────────────┐
        │ Python Код     │
        │ (безопасно)    │
        └────────┬───────┘
                 │
                 ▼
        ┌────────────────┐
        │ Google API     │
        │ (https)        │
        └────────┬───────┘
                 │
                 ▼
        ┌────────────────┐
        │ Google Sheets  │
        │ (защищено)     │
        └────────────────┘
```

## 📈 Масштабируемость

```
Текущая емкость:
- Мастера: 100 строк
- Клиенты: 200 строк
- Записи: 300 строк
- Услуги: 100 строк
- Расписание: 500 строк (максимум)
- Отзывы: 200 строк
- Прайс-лист: 150 строк

Total: ~1550 строк

Можно расширить:
┌─────────────────────────┐
│ Если нужно больше:      │
│ 1. Добавить строк       │
│ 2. Создать архив листов │
│ 3. Разделить на листы   │
│    по датам/категориям  │
└─────────────────────────┘
```

## 🔄 Синхронизация

```
┌─────────────────────────┐
│  Google Calendar        │
│  (мастера)              │
└────────────┬────────────┘
             │ sync
             ▼
┌─────────────────────────┐
│ Google Sheets           │
│ Лист "Расписание"       │
│ (автоматически)         │
└────────────┬────────────┘
             │ read
             ▼
┌─────────────────────────┐
│  Telegram Bot           │
│  (показывает свободные  │
│   слоты клиентам)       │
└─────────────────────────┘
```

---

**Диаграмма версия**: 1.0
**Последнее обновление**: 3 декабря 2025
